<!-- home.component.html -->
<!-- Chat Navigation -->
<app-chat-navigation
  (chatTypeChanged)="onChatTypeChanged($event)"
  (chatSelected)="onChatSelected($event)"
  (navigationStateChanged)="onNavigationStateChanged($event)"
></app-chat-navigation>

<!-- Main Chat Container -->
<div class="chat-container" [style.padding-left.px]="navigationWidth">
  <!-- Loading state -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-spinner">Loading...</div>
  </div>

  <!-- Main chat interface -->
  <div *ngIf="!isLoading && currentUser" class="chat-content">
    <!-- Header -->
    <div class="chat-header">
      <div class="header-content">
        <h1>{{ getCurrentChatTitle() }}</h1>
        <span class="subtitle">{{ getCurrentChatSubtitle() }}</span>
      </div>
      <div class="header-right">
        <div class="online-indicator" *ngIf="currentChatType === 'world'">
          <div class="online-dot"></div>
          <span>{{ onlineUsers.length }} Online</span>
        </div>

        <button
          *ngIf="currentChatType === 'groups' && !currentChatId"
          class="create-group-btn"
          (click)="openCreateGroupModal()"
          title="Create New Group"
        >
          <mat-icon>group_add</mat-icon>
          <span>Create Group</span>
        </button>

        <button class="profile-button" (click)="toggleMenu()">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
        </button>
      </div>
    </div>

    <!-- Profile Menu -->
    <div class="profile-menu-overlay" *ngIf="isMenuOpen" (click)="toggleMenu()">
      <div class="profile-menu" (click)="$event.stopPropagation()">
        <div class="profile-header">
          <div class="profile-avatar">
            <mat-icon>account_circle</mat-icon>
          </div>
          <div class="profile-info">
            <div class="profile-name">{{ currentUserDisplayName }}</div>
            <div class="profile-email">{{ currentUser.email }}</div>
          </div>
        </div>

        <div class="menu-divider"></div>

        <div class="menu-items">
          <button class="menu-item" (click)="onSettingsClick()">
            <mat-icon>settings</mat-icon>
            Settings
          </button>

          <button class="menu-item" (click)="onHelpClick()">
            <mat-icon>help</mat-icon>
            Help
          </button>

          <div class="menu-divider"></div>

          <button class="menu-item logout" (click)="onLogoutClick()">
            <mat-icon>logout</mat-icon>
            Log Out
          </button>
        </div>
      </div>
    </div>

    <!-- Empty state for groups without selection -->
    <div
      *ngIf="
        currentChatType === 'groups' &&
        !currentChatId &&
        groupChats.length === 0
      "
      class="empty-chat-state"
    >
      <div class="empty-content">
        <mat-icon class="empty-icon">group</mat-icon>
        <h3>No Group Chats Yet</h3>
        <p>Create your first group to start chatting with multiple people</p>
        <div class="empty-actions">
          <button class="create-group-cta" (click)="openCreateGroupModal()">
            <mat-icon>add</mat-icon>
            Create Your First Group
          </button>
        </div>
      </div>
    </div>

    <!-- Empty state for groups with selection prompt -->
    <div
      *ngIf="
        currentChatType === 'groups' &&
        !currentChatId &&
        groupChats.length > 0
      "
      class="empty-chat-state"
    >
      <div class="empty-content">
        <mat-icon class="empty-icon">forum</mat-icon>
        <h3>Select a Group Chat</h3>
        <p>Choose a group from the sidebar to start chatting</p>
        <div class="empty-actions">
          <button
            class="create-group-secondary"
            (click)="openCreateGroupModal()"
          >
            <mat-icon>add</mat-icon>
            Or Create New Group
          </button>
        </div>
      </div>
    </div>

    <!-- Empty state for private chats -->
    <div
      *ngIf="currentChatType === 'private' && !currentChatId"
      class="empty-chat-state"
    >
      <div class="empty-content">
        <mat-icon class="empty-icon">person</mat-icon>
        <h3>
          {{ privateChats.length === 0 ? 'No Private Conversations' : 'Select a
          Conversation' }}
        </h3>
        <p>
          {{ privateChats.length === 0 ? 'Start a private conversation with
          someone' : 'Choose a conversation from the sidebar' }}
        </p>
      </div>
    </div>

    <!-- Messages Area -->
    <div class="chat-messages" *ngIf="shouldShowMessages()">
      <div
        *ngFor="let message of getCurrentMessages()"
        class="message-wrapper"
        [class.own-message]="message.isOwnMessage"
        [class.system-message]="message.userId === 'system'"
      >
        <div class="message-bubble">
          <div
            class="message-header"
            *ngIf="!message.isOwnMessage && message.userId !== 'system'"
          >
            <span
              class="username clickable-username"
              (contextmenu)="onUsernameRightClick($event, message)"
            >
              {{ message.username }}
            </span>
            <span class="country">{{ message.country }}</span>
          </div>

          <div class="message-text">{{ message.text }}</div>

          <div class="message-time">
            {{ message.timestamp | date : 'HH:mm' }}
          </div>
        </div>
      </div>
    </div>

    <!-- Input Area -->
    <div class="chat-input" *ngIf="shouldShowInput()">
      <div class="input-container">
        <div class="user-indicator">
          <span class="your-flag">{{ currentUserCountry }}</span>
          <span class="your-name">{{ currentUserDisplayName }}</span>
        </div>

        <textarea
          [(ngModel)]="currentMessage"
          (keydown)="onKeyPress($event)"
          [placeholder]="getInputPlaceholder()"
          class="message-input"
          rows="1"
          [disabled]="!currentUser || isSendingMessage"
        >
        </textarea>

        <button
          (click)="sendMessage()"
          [disabled]="
            currentMessage.trim() === '' || !currentUser || isSendingMessage
          "
          class="send-button"
        >
          <div *ngIf="isSendingMessage" class="sending-spinner"></div>
          <svg
            *ngIf="!isSendingMessage"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22,2 15,22 11,13 2,9"></polygon>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Error state when user is not available -->
  <div *ngIf="!isLoading && !currentUser" class="error-container">
    <p>Please log in to access GlobalChat.</p>
    <button (click)="onGoToLogin()" class="login-button">Go to Login</button>
  </div>
</div>

<!-- Context Menu -->
<app-context-menu
  [user]="contextMenuUser"
  [position]="contextMenuPosition"
  [isVisible]="contextMenuVisible"
  [currentUserId]="currentUser?.id || ''"
  (actionSelected)="onContextMenuAction($event)"
  (menuClosed)="onContextMenuClosed()"
></app-context-menu>

<!-- Create Group Modal -->
<app-create-group-modal
  *ngIf="showCreateGroupModal"
  (groupCreated)="onGroupCreated($event)"
  (modalClosed)="onCreateGroupModalClosed()"
></app-create-group-modal>

<!-- Settings Modal -->
<app-setting-option
  *ngIf="isSettingsModalOpen"
  (closeSettings)="onSettingsClose()"
></app-setting-option>

<!-- Help Modal -->
<app-help *ngIf="isHelpModalOpen" (closeHelp)="onHelpClose()"></app-help>
